<% if ( server_name ) { -%>
# http
upstream http-<%- id %> {
    zone              upstream-zone-http-<%- id %> 1m;
    least_conn;
    keepalive         512; # max. number of non-active upstream connections
    keepalive_timeout 180s;
    # dns_update        30s;
    # dns_ipv6          off;
    # server            <%- upstream_server %>;
    server            0.0.0.0:1 down;
}
<% if ( cache ) { -%>

proxy_cache_path       <%- cache_dir %>/<%- id %> levels=1:2 keys_zone=<%- id %>:10m max_size=<%- cache_max_size %> inactive=<%- cache_inactive %> use_temp_path=off;
<% } -%>

server {
    listen                    *:80;
<% if ( ipv6 ) { -%>
    listen                    [::]:80;
<% } -%>
    server_name               <%- server_name %>;

    keepalive_timeout         180s;
    client_max_body_size      <%- client_max_body_size %>;

    location @backend {
        proxy_pass         http://http-<%- id %>;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Real-IP         $remote_addr;
<% if ( cache ) { -%>

        # cache
        proxy_cache        <%- id %>;
<% } -%>

        # websocket
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection $connection_upgrade;
    }

    location / {
        error_page 418 = @backend;
        return     418;
    }
}

<% } -%>
<% if ( stream_port ) { -%>
# stream
stream {
    upstream stream-<%- id %> {
        zone              upstream-zone-stream-<%- id %> 1m;
        least_conn;
        keepalive         512; # max. number of non-active upstream connections
        keepalive_timeout 180s;
        # dns_update        30s;
        # dns_ipv6          off;
        # server            <%- upstream_server %>;
        server            0.0.0.0:1 down;
    }

    server {
        listen                <%- stream_port %>;
        proxy_pass            stream-<%- id %>;
        proxy_connect_timeout 20s;
    }
}
<% } -%>
